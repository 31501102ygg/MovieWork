<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<title>Yip Tang Movie</title>
	<link rel="shortcut icon" href="img/pic/html_16px_1210190_easyicon.net.ico" />
	<!-- Font Awesome -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
	<!-- Bootstrap core CSS -->
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<!-- Material Design Bootstrap -->
	<link href="css/mdb.min.css" rel="stylesheet">
	<!-- Your custom styles (optional) -->
	<link href="css/style.css" rel="stylesheet">
	<style type="text/css">
		.searchbar {
			margin-top: 70px;
		}

		.input-group.md-form.form-sm.form-1 input {
			border: 1px solid #bdbdbd;
			border-top-right-radius: 0.25rem;
			border-bottom-right-radius: 0.25rem;
		}

		.input-group.md-form.form-sm.form-2 input {
			border: 1px solid #bdbdbd;
			border-top-left-radius: 0.25rem;
			border-bottom-left-radius: 0.25rem;
		}

		.page-footer,
		.top-nav-collapse {
			background-color: #4285f4;
		}
	</style>
</head>

<body>
	<!--Navbar-->
	<nav class="navbar navbar-expand-lg navbar-dark  blue darken-3 fixed-top scrolling-navbar">
		<div class="container">
			<!-- Navbar brand -->
			<a class="navbar-brand" href="#">
				<img src="img/pic/logo.png">
			</a>

			<!-- Collapse button -->
			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#basicExampleNav" aria-controls="basicExampleNav"
			 aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>

			<!-- Collapsible content -->
			<div class="collapse navbar-collapse" id="basicExampleNav">

				<!-- Links -->
				<ul class="navbar-nav mr-auto">
					<li class="nav-item ">
						<a class="nav-link" href="./main1.html">热映电影
							<span class="sr-only">(current)</span>
						</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="./searchfilms.html">寻找电影</a>
					</li>
					<li class="nav-item active">
						<a class="nav-link" href="./filmreview.html">影评</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="./personcollect.html">个人收藏</a>
					</li>
					<!-- Dropdown -->
					<!--<li class="nav-item dropdown">
						<a class="nav-link dropdown-toggle" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Dropdown</a>
						<div class="dropdown-menu dropdown-primary" aria-labelledby="navbarDropdownMenuLink">
							<a class="dropdown-item" href="#">Action</a>
							<a class="dropdown-item" href="#">Another action</a>
							<a class="dropdown-item" href="#">Something else here</a>
						</div>
					</li>-->

				</ul>
				<!-- Links -->
				<ul class="navbar-nav mr-auto nav-flex-icons">
					<li class="nav-item">
						<a class="nav-link waves-effect waves-light" href="./aboutus.html">
							<i class="fa fa-gear"></i> 关于我们</a>
					</li>
					<li class="nav-item">
						<a class="nav-link waves-effect waves-light" href="./contact.html">
							<i class="fa fa-envelope"></i> 联系我们</a>
					</li>
					<li class="nav-item dropdown">
						<a class="nav-link dropdown-toggle waves-effect waves-light" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true"
						 aria-expanded="true">
							<i class="fa fa-user"></i> 用户名称
						</a>
						<div class="dropdown-menu dropdown-menu-right dropdown-default" aria-labelledby="navbarDropdownMenuLink">
							<a class="dropdown-item waves-effect waves-light" href="./account.html">我的账号</a>
							<a id="out" class="dropdown-item waves-effect waves-light" href="./signup.html">退出</a>
						</div>
					</li>
				</ul>
			</div>
			<!-- Collapsible content -->
		</div>
	</nav>
	<!--/.Navbar-->
	<div class="searchbar">
		<div class="container">
			<div class="input-group md-form form-sm form-1 pl-0">
				<div class="input-group-prepend">
					<span class="input-group-text cyan lighten-2" id="basic-text1">
						<i class="fa fa-search text-white" aria-hidden="true"></i>
					</span>
				</div>
				<input id="sInput" class="form-control my-0 py-1 col-md-6 col-lg-4" type="text" placeholder="影评搜索" aria-label="Search">
			</div>
		</div>
	</div>
	<div class="main-content">
		<div class="container"></div>
	</div>
	<!-- Start your project here-->

	<footer class="page-footer text-center font-small mt-4 wow fadeIn" style="visibility: visible; animation-name: fadeIn;">

		<!--Call to action-->
		<div class="pt-4">
				<div class="container">
					<div class="row" style="text-align: center">
						<div class="col-md-6" >
							<div class="content tag-linksite">
								<h4 class="title">相关网站</h4>
								<a href="https://movie.douban.com/" target="_blank">豆瓣电影</a>
								<i style="font-style:normal">|</i>
								<a href="http://maoyan.com/" target="_blank">猫眼电影</a>
							</div>
						</div>
						<div class="col-md-6">
							<div class="content tag-friendsite" >
								<div class="content tag-cloud friend-links">
								<h4 class="title">友情链接</h4>
									<a href="http://www.bootcss.com" title="Bootstrap 中文网" target="_blank">Bootstrap中文网</a>
									<i style="font-style:normal">|</i>
									<a href="https://mdbootstrap.com/" title="MDB 官网" target="_blank">MDB官网</a>
									<i style="font-style:normal">|</i>
									<a href="https://www.jquery123.com/" title="jQuery 中文文档" target="_blank">jQuery中文文档</a>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		<!--/.Call to action-->

		<hr class="my-4">

		<!-- Social icons -->
		<div class="pb-4">
			<a href="https://www.facebook.com/mdbootstrap" target="_blank">
				<i class="fa fa-facebook mr-3"></i>
			</a>

			<a href="https://twitter.com/MDBootstrap" target="_blank">
				<i class="fa fa-twitter mr-3"></i>
			</a>

			<a href="https://www.youtube.com/watch?v=7MUISDJ5ZZ4" target="_blank">
				<i class="fa fa-youtube mr-3"></i>
			</a>

			<a href="https://plus.google.com/u/0/b/107863090883699620484" target="_blank">
				<i class="fa fa-google-plus mr-3"></i>
			</a>

			<a href="https://dribbble.com/mdbootstrap" target="_blank">
				<i class="fa fa-dribbble mr-3"></i>
			</a>

			<a href="https://pinterest.com/mdbootstrap" target="_blank">
				<i class="fa fa-pinterest mr-3"></i>
			</a>

			<a href="https://github.com/mdbootstrap/bootstrap-material-design" target="_blank">
				<i class="fa fa-github mr-3"></i>
			</a>

			<a href="http://codepen.io/mdbootstrap/" target="_blank">
				<i class="fa fa-codepen mr-3"></i>
			</a>
		</div>
		<!-- Social icons -->

		<!--Copyright-->
		<div class="footer-copyright py-3">
			<font style="vertical-align: inherit;">
				<font style="vertical-align: inherit;">
					©2018版权所有：
				</font>
			</font>
			<a href="https://mdbootstrap.com/bootstrap-tutorial/" target="_blank">
				<font style="vertical-align: inherit;">
					<font style="vertical-align: inherit;">Yip&amp;Tang </font>
				</font>
			</a>
		</div>
		<!--/.Copyright-->

	</footer>

	<!-- /Start your project here-->

	<!-- SCRIPTS -->
	<!-- JQuery -->
	<script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
	<!-- Bootstrap tooltips -->
	<script type="text/javascript" src="js/popper.min.js"></script>
	<!-- Bootstrap core JavaScript -->
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<!-- MDB core JavaScript -->
	<script type="text/javascript" src="js/mdb.min.js"></script>

	<script type="text/javascript">
		console.log(sessionStorage.getItem("username"));
		$("#navbarDropdownMenuLink").html('<i class="fa fa-user"></i>' + sessionStorage.getItem("username"));
		//加载影评
		loadReview();
		//搜索功能
		$("#basic-text1").click(function () {
			let filmname = $("#sInput").val();
			let url = "http://127.0.0.1:3000/filmreviews/searchfilmreviews?" + "filmname=" + filmname;
			fetch(url, {
				method: "GET"
			}).then(function (res) {
				return res.json();
			}).then(function (jsons) {
				if (jsons.length == 0) {
					if ($(".main-content").eq(0).children("div.container").eq(0).text() != '')
						return;
					loadReview();
				}
				$(".main-content").eq(0).children("div.container").eq(0).empty();
				for (let i = 0; i < jsons.length; i++) {
					let info = jsons[i];
					let card = createReviewElement(info);
					console.log(card);
					$(".main-content").eq(0).children("div.container").eq(0).append(card);
				}
			}).catch(function (ex) {
				console.log("搜索出错：" + ex);
			})
		})

		//加载影评函数
		function loadReview() {
			let url = "http://127.0.0.1:3000/filmreviews/loadfilmreviews";
			fetch(url, {
				method: "GET"
			}).then(function (res) {
				return res.json();
			}).then(function (jsons) {
				console.log(jsons);
				for (let i = 0; i < jsons.length; i++) {
					let info = jsons[i];
					let card = createReviewElement(info);
					$(".main-content").eq(0).children("div.container").eq(0).append(card);
				}
			}).catch(function (ex) {
				console.log("print ex: " + ex);
			})
		}
		function createReviewElement(info) {
			let card = document.createElement("div");
			card.className = "card mb-3 text-center hoverable";
			let card_body = document.createElement("div");
			card_body.className = "card-body";
			let row = document.createElement("div");
			row.className = "row";
			//电影图片位置
			let col = document.createElement("div");//容器
			col.className = "col-md-2 offset-md-1 mx-3 my-3";
			let view = document.createElement("div");
			view.className = "view overlay col-md-11";
			let img = document.createElement("img");
			img.setAttribute("src", info.imghref);
			img.setAttribute("alt", "电影图片");
			img.className = "img-fluid";
			let a = document.createElement("a");
			a.setAttribute("href", "./filminfo.html");
			let mask = document.createElement("div");
			mask.className = "mask rgba-white-slight";
			a.appendChild(mask);
			view.appendChild(img);
			view.appendChild(a);
			col.appendChild(view);
			row.appendChild(col);
			//影评信息
			// card.appendChild(row);
			// return card;
			//基本信息
			col = document.createElement("div");
			col.className = "col-md-8 text-left ml-3 mt-3";
			let row_info = document.createElement("div");
			row_info.className = "row";
			let colmd = document.createElement("div");
			colmd.className = "col-md-4";
			let h6 = document.createElement("h6");
			h6.className = "font-bold pb-1";
			h6.innerHTML = '<i class="fa fa-user"></i> ' + info.username;
			let span_scoreStar = createScoreStar(info.score);
			let time = document.createElement("div");
			time.className = "col-md-6";
			let i = document.createElement("i");
			i.textContent = timeFormatter(info.createdate);
			time.appendChild(i);
			colmd.appendChild(h6);
			row_info.appendChild(colmd);
			row_info.appendChild(span_scoreStar);
			row_info.appendChild(time);
			col.appendChild(row_info);
			//标题
			a = document.createElement("a");
			let h4 = document.createElement("h4");
			h4.className = "mb-4";
			let strong = document.createElement("strong");
			strong.textContent = info.title;
			h4.appendChild(strong);
			a.appendChild(h4);
			col.appendChild(a);
			//缩略影评
			let shortreview = document.createElement("div");
			shortreview.className = "shortreview";
			shortreview.setAttribute("id", "short" + info.filmid);
			let p = document.createElement("p");
			p.textContent = info.shortreview;
			shortreview.appendChild(p);
			col.appendChild(shortreview);
			//完整影评
			let longreview = longReviewToP(info);
			col.appendChild(longreview);
			//展开按钮
			a = document.createElement("a");
			a.className = "dropdownorup mb-0";
			a.setAttribute("value", info.filmid);
			a.innerHTML = '显示全部' + '<i class="fa fa-angle-down rotate-icon"></i>'
			//添加click事件
			a.addEventListener("click", function () {
				let filmid = this.getAttribute("value");
				if (this.children[0].className.indexOf("fa-angle-down") > 0) {
					$("#short" + filmid).eq(0).attr("style", "display:none");
					$("#long" + filmid).eq(0).attr("style", "display:block");
					this.textContent = "收起";
					let i = document.createElement("i");
					i.className = "fa fa-angle-up rotate-icon";
					this.appendChild(i);
				}
				else {
					$("#long" + filmid).eq(0).attr("style", "display:none");
					$("#short" + filmid).eq(0).attr("style", "display:block");
					this.textContent = "查看全部";
					let i = document.createElement("i");
					i.className = "fa fa-angle-down rotate-icon";
					this.appendChild(i);
				}
			})
			col.appendChild(a);

			row.appendChild(col);
			card_body.appendChild(row);
			card.appendChild(card_body);
			return card;
		}
		function createScoreStar(score) {
			let span = document.createElement("span");
			span.className = "col-md-2";
			span.setAttribute("style", "color:#fdd835 ")
			for (let i = 0; i < score; i++) {
				let icon = document.createElement("i");
				icon.className = "fa fa-star";
				span.appendChild(icon);
			}
			for (let i = 0; i < 5 - score; i++) {
				let icon = document.createElement("i");
				icon.className = "fa fa-star-o";
				span.appendChild(icon);
			}
			return span;
		}
		function longReviewToP(info) {
			let longreview = document.createElement("div");
			longreview.className = "longreview";
			longreview.setAttribute("id", "long" + info.filmid);
			longreview.setAttribute("style", "display: none;");
			//text分段落
			let text = info.longreview;
			var paragraphs = text.split(/[\n]+/g);
			//标签p填充段落
			for (let i = 0; i < paragraphs.length; i++) {
				let p = document.createElement("p");
				p.textContent = paragraphs[i];
				longreview.appendChild(p);
			}
			return longreview;
		}

		//时间格式转换函数
		function timeFormatter(value) {
			var da = new Date(value.replace("/Date(", "").replace(")/", "").split("+")[0]);
			return da.getFullYear() + "-" + (da.getMonth() + 1) + "-" + da.getDate() + " " + da.getHours() + ":" + da.getMinutes() + ":" + da.getSeconds();
		}

		//退出账户
		$("#out").click(function () {
			localStorage.removeItem("username");
			localStorage.removeItem("password");
			sessionStorage.removeItem("username");
			sessionStorage.removeItem("username");
			sessionStorage.removeItem("userid");
		})
	</script>
</body>

</html>